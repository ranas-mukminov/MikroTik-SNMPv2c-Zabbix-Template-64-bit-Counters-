# MikroTik SNMPv2c Zabbix Template (64-битные счётчики)

Шаблон мониторинга Zabbix для устройств MikroTik RouterOS через SNMPv2c с 64-битными счётчиками трафика.

[English](README.md) | **[Русский]**

---

## Обзор

Данный шаблон обеспечивает комплексный мониторинг устройств MikroTik RouterOS через Zabbix. Он предназначен для сетевых инженеров, провайдеров и корпоративных IT-команд, которым нужен надёжный SNMP-мониторинг с точной статистикой трафика.

**Почему важны 64-битные счётчики:**

На высокоскоростных каналах (1 Гбит/с и выше) 32-битные SNMP-счётчики могут переполняться за считанные минуты, что приводит к некорректной статистике трафика и графикам. Устройства MikroTik поддерживают 64-битные счётчики (ifHCInOctets/ifHCOutOctets), которые решают эту проблему за счёт гораздо большего диапазона значений. Этот шаблон использует 64-битные счётчики по умолчанию и переключается на 32-битные только в том случае, если устройство их не поддерживает.

---

## Возможности

### Мониторинг интерфейсов
- Автоматическое обнаружение интерфейсов через Low-Level Discovery (LLD)
- Счётчики входящего и исходящего трафика (64-битные: ifHCInOctets, ifHCOutOctets)
- Утилизация полосы пропускания в процентах от скорости интерфейса
- Счётчики ошибок и отброшенных пакетов (входящие и исходящие)
- Мониторинг широковещательных и мультикаст-пакетов
- Отслеживание операционного и административного статуса
- Информация о скорости интерфейса и его псевдониме

### Мониторинг состояния системы
- Мониторинг времени работы (uptime)
- Загрузка CPU с настраиваемыми порогами
- Использование памяти (общая, используемая, процент)
- Мониторинг температуры железа (специфичный для MikroTik OID)
- Мониторинг напряжения блока питания
- Инвентаризация: версия RouterOS и серийный номер

### Протоколы маршрутизации
- Обнаружение и мониторинг состояния OSPF-соседей
- Обнаружение и отслеживание состояния BGP-пиров

### Оповещения
- Обнаружение обрыва канала с гистерезисом (предотвращение ложных срабатываний)
- Оповещения о высоком уровне ошибок
- Триггеры на высокую загрузку CPU и памяти
- Оповещения по порогам температуры и напряжения
- Определение недоступности устройства через ICMP

---

## Требования

- **Zabbix Server:** 5.x, 6.x или 7.x
- **MikroTik RouterOS:** 6.x или 7.x с включённым SNMP
- **Протокол SNMP:** SNMPv2c (шаблон настроен для SNMPv2c; SNMPv3 можно использовать на стороне хоста без изменения шаблона)
- **Сетевая связность:** Zabbix-сервер должен иметь доступ к MikroTik на UDP-порт 161

---

## Настройка SNMP на MikroTik

Включите SNMP на вашем устройстве MikroTik и настройте community string:

```bash
/snmp
set enabled=yes contact="admin@example.com" location="ДатаЦентр-А"

/snmp community
set [find default=yes] name="МойБезопасныйКлюч" addresses=10.0.0.100/32
```

**Замечания по безопасности:**
- Всегда используйте сильную, уникальную строку community — никогда не используйте `public` или `private`
- Ограничивайте доступ SNMP по IP-адресу источника (параметр `addresses=`)
- Для продакшн-сред рекомендуется использовать SNMPv3 с аутентификацией и шифрованием
- Размещайте интерфейсы управления в изолированном VLAN с правилами файрвола

Проверьте доступ SNMP с вашего Zabbix-сервера:

```bash
snmpwalk -v2c -c МойБезопасныйКлюч <ip-адрес-mikrotik> system
```

---

## Импорт шаблона

1. Войдите в веб-интерфейс Zabbix
2. Перейдите в **Настройка → Шаблоны**
3. Нажмите **Импорт**
4. Выберите файл шаблона: `template_mikrotik_snmpv2c_advanced_zbx72.xml`
5. Отметьте следующие опции:
   - Создать новые
   - Обновить существующие
   - Удалить отсутствующие (при обновлении)
6. Нажмите **Импорт**

После импорта шаблон появится под именем `Template MikroTik SNMPv2c Advanced (Production)` в разделе **Templates/Network devices**.

---

## Привязка шаблона к узлу

1. Перейдите в **Настройка → Узлы сети**
2. Нажмите **Создать узел сети** или отредактируйте существующий
3. Заполните информацию об узле:
   - **Имя узла:** `mikrotik-router-01`
   - **Группы:** Выберите или создайте `Routers`
4. Добавьте **SNMP-интерфейс**:
   - **Тип:** SNMP
   - **IP-адрес:** (IP вашего MikroTik, например `192.168.1.1`)
   - **Порт:** `161`
   - **Версия SNMP:** SNMPv2
   - **Сообщество SNMP:** `{$SNMP_COMMUNITY}` (оставьте как макрос)
5. Перейдите на вкладку **Шаблоны**
6. Привяжите шаблон: `Template MikroTik SNMPv2c Advanced (Production)`
7. Перейдите на вкладку **Макросы**, выберите **Макросы узла сети**
8. Добавьте или переопределите следующий макрос:
   - **Макрос:** `{$SNMP_COMMUNITY}`
   - **Значение:** `МойБезопасныйКлюч` (фактическая строка community)
9. Нажмите **Добавить** или **Обновить**

В течение нескольких минут Zabbix начнёт собирать данные. Проверьте **Мониторинг → Последние данные**.

---

## Макросы и настройка

Шаблон использует макросы для гибкой настройки. Переопределяйте эти макросы на уровне узла или шаблона по мере необходимости.

### Аутентификация SNMP
| Макрос | По умолчанию | Описание |
|--------|--------------|----------|
| `{$SNMP_COMMUNITY}` | `CHANGE_ME_SNMPV2C` | Строка community для SNMPv2c |

### Фильтры обнаружения интерфейсов
| Макрос | По умолчанию | Описание |
|--------|--------------|----------|
| `{$IF.LLD.FILTER.MATCH}` | `.*` | Регулярное выражение для включения интерфейсов |
| `{$IF.LLD.FILTER.NOT_MATCHES}` | `(?i:loopback\|virtual\|vlan\|gre\|pppoe\|eoip\|6to4)` | Регулярное выражение для исключения виртуальных/туннельных интерфейсов |
| `{$IF.LLD.FILTER.ADMIN_STATUS}` | `^1$` | Обнаруживать только интерфейсы со статусом "up" (1=up, 2=down) |

### Пороги CPU и памяти
| Макрос | По умолчанию | Описание |
|--------|--------------|----------|
| `{$CPU.UTIL.WARN}` | `80` | Порог предупреждения загрузки CPU (%) |
| `{$CPU.UTIL.CRIT}` | `90` | Критический порог загрузки CPU (%) |
| `{$MEM.UTIL.WARN}` | `85` | Порог предупреждения использования памяти (%) |
| `{$MEM.UTIL.CRIT}` | `95` | Критический порог использования памяти (%) |

### Примеры

**Исключить VPN и туннельные интерфейсы из обнаружения:**

Установите `{$IF.LLD.FILTER.NOT_MATCHES}`:
```
(?i:loopback|virtual|vlan|gre|pppoe|eoip|6to4|wireguard|ovpn)
```

**Настроить пороги CPU для менее критичного устройства:**

Переопределите на уровне узла:
```
{$CPU.UTIL.WARN} = 90
{$CPU.UTIL.CRIT} = 95
```

**Мониторить только конкретные интерфейсы (например, ether1-ether5):**

Установите `{$IF.LLD.FILTER.MATCH}`:
```
^ether[1-5]$
```

---

## Объяснение 64-битных счётчиков

SNMP предоставляет два набора счётчиков трафика:

- **32-битные счётчики** (ifInOctets, ifOutOctets): Максимальное значение 4 294 967 295 байт (~4 ГБ). На канале 1 Гбит/с при полной загрузке эти счётчики переполняются каждые 34 секунды.
- **64-битные счётчики** (ifHCInOctets, ifHCOutOctets): Максимальное значение приблизительно 18 эксабайт. Эти счётчики не переполнятся даже на каналах 10 Гбит/с и быстрее.

Когда счётчик переполняется, системы мониторинга могут показывать некорректные данные (отрицательные значения, всплески или разрывы на графиках). Вот почему 64-битные счётчики критически важны для точного мониторинга высокоскоростных сетей.

Этот шаблон спроектирован для использования 64-битных счётчиков по умолчанию. Если устройство MikroTik или интерфейс не поддерживает 64-битные счётчики (очень старые версии RouterOS), шаблон переключится на 32-битные счётчики. Для наилучших результатов убедитесь, что ваша версия RouterOS актуальна (6.x или 7.x).

---

## Решение типовых проблем

### Нет данных с узла

**Возможные причины:**
- SNMP не включён на MikroTik
- Неверная строка community в настройках узла Zabbix
- Файрвол блокирует UDP-порт 161
- IP-адрес Zabbix не разрешён в настройках SNMP на MikroTik

**Как проверить:**
1. Убедитесь, что SNMP включён на MikroTik:
   ```bash
   /snmp print
   ```
2. Проверьте SNMP-подключение с Zabbix-сервера:
   ```bash
   snmpwalk -v2c -c ВашCommunity <ip-mikrotik> system
   ```
3. Проверьте настройки интерфейса узла в Zabbix (IP, порт, community)
4. Просмотрите логи Zabbix-сервера на наличие ошибок SNMP timeout

### Интерфейсы не обнаруживаются

**Возможные причины:**
- Фильтры LLD исключают все интерфейсы
- Интерфейсы административно выключены
- SNMP не предоставляет данные об интерфейсах

**Как проверить:**
1. Выведите список всех интерфейсов на MikroTik:
   ```bash
   /interface print
   ```
2. Настройте макрос `{$IF.LLD.FILTER.NOT_MATCHES}` для включения нужных интерфейсов
3. Запустите обнаружение вручную в Zabbix:
   **Настройка → Узлы сети → [Узел] → Обнаружение → Выполнить сейчас**

### Всплески трафика или странные значения

**Возможные причины:**
- Переполнение счётчиков (32-битные на быстрых каналах)
- Перезагрузка устройства (счётчики сбрасываются в ноль)
- Слишком большой интервал опроса

**Как исправить:**
- Убедитесь, что используются 64-битные счётчики
- Обновите RouterOS, если используете старую версию
- Уменьшите интервал опроса для критичных интерфейсов (отредактируйте элементы данных или используйте макрос `{$IF.POLL.INTERVAL}`)

### Таймауты SNMP

**Возможные причины:**
- Высокая загрузка CPU на MikroTik
- Сетевые задержки или потери пакетов
- Слишком высокая частота SNMP-запросов

**Как исправить:**
- Увеличьте таймаут SNMP в настройках интерфейса узла Zabbix
- Уменьшите частоту опроса (увеличьте интервалы элементов данных)
- Проверьте сетевое подключение и задержки с помощью `ping` и `traceroute`
- Проверьте загрузку CPU на MikroTik командой `/system resource print`

---

## Дорожная карта

Запланированные улучшения для будущих релизов:

- Тестирование и валидация шаблона на последних стабильных релизах RouterOS v7.x
- Добавление более гранулярных LLD-фильтров для типов интерфейсов (проводные, беспроводные, мосты)
- Улучшение гистерезиса триггеров и зависимостей оповещений для снижения ложных срабатываний
- Создание опциональных примеров конфигурации SNMPv3 с аутентификацией и шифрованием
- Разработка примеров дашбордов Grafana для визуализации данных, собираемых этим шаблоном
- Добавление мониторинга беспроводных клиентов для точек доступа MikroTik

Вклады и предложения приветствуются. См. раздел [Вклад и доработка](#вклад-и-доработка) ниже.

---

## Вклад и доработка

Мы приветствуем вклад в проект! Чтобы внести изменения:

1. Сделайте fork репозитория
2. Создайте ветку для новой функции: `git checkout -b feature/мое-улучшение`
3. Внесите изменения и тщательно протестируйте их
4. Зафиксируйте изменения: `git commit -m "Добавлена функция: описание"`
5. Отправьте изменения в вашу ветку: `git push origin feature/мое-улучшение`
6. Откройте Pull Request

**Рекомендации:**
- Сохраняйте консистентность имён шаблонов и ключей с существующей структурой
- Избегайте breaking changes без чётких инструкций по миграции
- Тестируйте изменения на реальном устройстве MikroTik
- Документируйте протестированные версии RouterOS и Zabbix в описании PR
- Убедитесь, что XML валиден перед отправкой (используйте `xmllint` или тестовые скрипты в `tests/`)

---

## Автор и лицензия

**Автор:** Ранас Мукминов  
**Сайт:** [run-as-daemon.ru](https://run-as-daemon.ru)

Данный проект является открытым. Подробности лицензирования см. в репозитории.
