# MikroTik SNMP Zabbix Templates (64-битные счётчики)

Готовые к продакшену шаблоны Zabbix для MikroTik RouterOS с 64-битными счётчиками интерфейсов, поддержка SNMPv2c и SNMPv3.

[English](README.md) | Русский

---

## Об авторе

**Ранас Мукминов** — DevOps/SRE-инженер и специалист по сетям, специализируется на:

- Мониторинг и наблюдаемость: Zabbix, Prometheus, Grafana, Loki
- Мониторинг сетевого оборудования: MikroTik, Cisco, Juniper и другие
- Автоматизация и оркестрация: Ansible, Docker, Kubernetes

**Контакты:**
- Сайт: [run-as-daemon.ru](https://run-as-daemon.ru)
- GitHub: [ranas-mukminov](https://github.com/ranas-mukminov)
- Telegram: [@run_as_daemon](https://t.me/run_as_daemon)

---

## Что это за репозиторий

Этот репозиторий содержит шаблоны мониторинга Zabbix для устройств MikroTik RouterOS с фокусом на точном измерении трафика через 64-битные счётчики интерфейсов. Шаблоны поддерживают протоколы SNMPv2c и SNMPv3 и протестированы на современных версиях Zabbix (7.x и 6.0 LTS).

**Ключевые возможности:**

- 64-битные счётчики интерфейсов (ifHCInOctets/ifHCOutOctets) предотвращают переполнение счётчиков на высокоскоростных каналах
- Автоматическое обнаружение интерфейсов с гибкой фильтрацией
- Мониторинг состояния системы: CPU, память, температура, напряжение
- Сетевые метрики: трафик, ошибки, отброшенные пакеты, широковещательные/мультикаст-пакеты
- Мониторинг протоколов маршрутизации: соседи OSPF, пиры BGP
- Настраиваемые пороги через макросы
- Комплексная система оповещений с гистерезисом триггеров для уменьшения ложных срабатываний

---

## Структура репозитория

```text
.
├── template_mikrotik_snmpv2c_advanced_zbx72.xml
├── template_mikrotik_snmpv2c_zbx72_uuid32.xml
├── template_mikrotik_snmpv3_advanced_zbx72.xml
├── node-exporter-full-stack/
├── examples/
├── tests/
├── CHANGELOG.md
└── README.md / README.ru.md
```

**Доступные шаблоны:**

| Файл                                         | Протокол | Zabbix | Примечания                        |
| -------------------------------------------- | -------- | ------ | --------------------------------- |
| template_mikrotik_snmpv2c_advanced_zbx72.xml | SNMPv2c  | 7.2+   | Расширенный шаблон, 64-битные IF  |
| template_mikrotik_snmpv2c_zbx72_uuid32.xml   | SNMPv2c  | 7.2+   | Базовый шаблон, на основе UUID    |
| template_mikrotik_snmpv3_advanced_zbx72.xml  | SNMPv3   | 7.2+   | Расширенный, безопасный SNMPv3    |

---

## Требования

**Zabbix:**
- Server 7.2+ (также работает с 7.x и 6.0 LTS при небольших настройках при необходимости)

**MikroTik RouterOS:**
- Версия 6.x или 7.x (рекомендуется 7.x для лучшей поддержки функций)

**SNMP:**
- SNMPv2c для 64-битных счётчиков
- Поддержка SNMPv3 доступна через специальный шаблон

**Сеть:**
- Zabbix Server или Proxy должен иметь доступ к MikroTik на UDP-порт 161

---

## Быстрый старт

### Включение SNMP на MikroTik (SNMPv2c)

Подключитесь к вашему устройству MikroTik и настройте SNMP:

```bash
/snmp
set enabled=yes contact="admin@example.com" location="ДатаЦентр-А"

/snmp community
set [find default=yes] name="МойБезопасныйКлюч" addresses=10.0.0.100/32
```

Добавьте правило файрвола для разрешения SNMP с вашего Zabbix-сервера:

```bash
/ip firewall filter
add chain=input protocol=udp dst-port=161 src-address=10.0.0.100 \
    action=accept comment="Разрешить SNMP с Zabbix"
```

Проверьте доступ SNMP с вашего Zabbix-сервера:

```bash
snmpwalk -v2c -c МойБезопасныйКлюч <ip-mikrotik> system
```

### Импорт шаблона в Zabbix

1. Войдите в веб-интерфейс Zabbix
2. Перейдите в **Настройка → Шаблоны**
3. Нажмите **Импорт**
4. Выберите файл шаблона: `template_mikrotik_snmpv2c_advanced_zbx72.xml`
5. Включите следующие опции импорта:
   - Создать новые
   - Обновить существующие
   - Удалить отсутствующие (при обновлении существующего шаблона)
6. Нажмите **Импорт**

Шаблон появится как `Template MikroTik SNMPv2c Advanced (Production)` в разделе **Templates/Network devices**.

### Привязка шаблона к узлу MikroTik

1. Перейдите в **Настройка → Узлы сети**
2. Нажмите **Создать узел сети** или выберите существующий узел
3. Настройте параметры узла:
   - **Имя узла:** `mikrotik-router-01`
   - **Группы:** `Routers` (или создайте новую группу)
4. Добавьте SNMP-интерфейс:
   - **Тип:** SNMP
   - **IP-адрес:** IP вашего MikroTik (например, `192.168.1.1`)
   - **Порт:** `161`
   - **Версия SNMP:** SNMPv2
   - **Сообщество SNMP:** `{$SNMP_COMMUNITY}` (оставьте как ссылку на макрос)
5. Перейдите на вкладку **Шаблоны**
6. Привяжите шаблон: `Template MikroTik SNMPv2c Advanced (Production)`
7. Перейдите на вкладку **Макросы** и выберите **Макросы узла сети**
8. Переопределите макрос community для SNMP:
   - **Макрос:** `{$SNMP_COMMUNITY}`
   - **Значение:** `МойБезопасныйКлюч` (ваша фактическая строка community)
9. Нажмите **Добавить** или **Обновить**

Подождите несколько минут, пока Zabbix соберёт данные, затем проверьте в **Мониторинг → Последние данные** и проверьте наличие проблем в **Мониторинг → Проблемы**.

---

## Что мониторится

Шаблоны собирают комплексные метрики с устройств MikroTik:

**Состояние устройства:**
- Время работы системы (uptime)
- Загрузка CPU
- Использование памяти (всего, используется, свободно)
- Использование диска
- Температура оборудования (где доступно)
- Напряжение блока питания

**Сетевые интерфейсы:**
- RX/TX трафик (входящие/исходящие байты и пакеты)
- Счётчики ошибок (входящие/исходящие ошибки)
- Счётчики отброшенных пакетов (входящие/исходящие)
- Операционный и административный статус интерфейсов
- Описания и псевдонимы интерфейсов
- Скорость и дуплекс интерфейсов
- Процент утилизации пропускной способности

**Дополнительные метрики** (в зависимости от версии RouterOS и шаблона):
- Состояния соседей OSPF
- Сессии пиров BGP
- Время отклика ICMP ping и потеря пакетов

Точный набор мониторируемых элементов зависит от вашей версии RouterOS и конкретного выбранного шаблона. Вы можете изучить все элементы в Zabbix, просмотрев конфигурацию шаблона.

---

## SNMPv3 (рекомендуется)

Для продакшн-окружений настоятельно рекомендуется использовать SNMPv3 с аутентификацией и шифрованием вместо SNMPv2c.

### Настройка SNMPv3 на MikroTik

Создайте пользователя SNMPv3 с аутентификацией и шифрованием:

```bash
/snmp community
set [find default=yes] disabled=yes

/snmp
set enabled=yes engine-id=<ваш-engine-id> contact="admin@example.com"

/snmp user
add name=zabbix_user group=read auth-protocol=SHA1 auth-password="AuthPass123!" \
    encryption-protocol=AES encryption-password="PrivPass123!"
```

### Настройка SNMPv3 в Zabbix

1. Импортируйте шаблон SNMPv3: `template_mikrotik_snmpv3_advanced_zbx72.xml`
2. При настройке интерфейса узла выберите:
   - **Версия SNMP:** SNMPv3
   - **Имя контекста:** (оставьте пустым)
   - **Имя безопасности:** `zabbix_user`
   - **Уровень безопасности:** authPriv
   - **Протокол аутентификации:** SHA
   - **Парольная фраза аутентификации:** `AuthPass123!`
   - **Протокол шифрования:** AES
   - **Парольная фраза шифрования:** `PrivPass123!`
3. Привяжите шаблон SNMPv3 к узлу

SNMPv3 шифрует SNMP-трафик и предотвращает несанкционированный доступ к вашим устройствам.

---

## Отображение и Value Mapping в Zabbix

Для правильного отображения собранных данных настройте отображения значений и параметры отображения в Zabbix.

### Отображение статуса интерфейса (Value Mapping)

Создайте отображение значений для операционного статуса интерфейса:

1. Перейдите в **Администрирование → Общие → Отображение значений**
2. Нажмите **Создать карту значений**
3. Название: `IfOperStatus`
4. Добавьте следующие отображения:

   | Значение | Отображается как |
   | -------- | ---------------- |
   | 1        | up               |
   | 2        | down             |
   | 3        | testing          |
   | 4        | unknown          |
   | 5        | dormant          |
   | 6        | notPresent       |
   | 7        | lowerLayerDown   |

5. Сохраните отображение значений

Это отображение используется для элементов вроде `ifOperStatus[{#IFNAME}]` и `ifAdminStatus[{#IFNAME}]` для отображения состояний интерфейсов в виде читаемого текста вместо числовых кодов.

### Нормализация скорости интерфейса

Для отображения скоростей интерфейсов в удобочитаемых единицах:

1. Отредактируйте элементы скорости интерфейсов в шаблоне
2. Добавьте шаг предобработки:
   - **Тип:** Пользовательский множитель
   - **Параметры:** `0.000001` (преобразует бит/с в Мбит/с)
3. Установите **Единицы** в `Mbps`
4. Для элементов утилизации пропускной способности используйте вычисляемые элементы, которые ссылаются на макросы:
   - `{$IF_UTIL_WARN}` для порога предупреждения (например, 80%)
   - `{$IF_UTIL_HIGH}` для высокого порога (например, 90%)

### Отображение типов интерфейсов MikroTik

Создайте отображение значений для специфичных типов интерфейсов MikroTik:

1. Перейдите в **Администрирование → Общие → Отображение значений**
2. Нажмите **Создать карту значений**
3. Название: `MikroTik.Interface.Type`
4. Добавьте общие отображения:

   | Значение | Отображается как |
   | -------- | ---------------- |
   | 6        | ether            |
   | 24       | vlan             |
   | 53       | pppoe            |
   | 195      | lte              |

5. Расширьте этот список по необходимости для других типов интерфейсов

Примените это отображение к элементам вроде `mtIfType[{#IFNAME}]`, если ваш шаблон предоставляет информацию о типе интерфейса.

### Графики трафика в битах в секунду

Для отображения графиков трафика в битах в секунду вместо байтов:

1. Оставьте необработанные элементы SNMP, собирающие данные в байтах (без изменений)
2. При создании или редактировании графиков:
   - Выберите элементы трафика (входящие/исходящие байты)
   - Примените **множитель** `8` для преобразования байтов в биты
   - Установите **Единицы оси Y** в `bit/s`
3. Альтернативно, создайте вычисляемые элементы, которые умножают счётчики байтов на 8

Этот подход сохраняет необработанные данные в байтах для точности, одновременно отображая привычные единицы бит/с на графиках.

---

## Решение типовых проблем

### Нет данных с узла

Проверьте следующее:
- Убедитесь, что SNMP включён на MikroTik: `/snmp print`
- Проверьте подключение с помощью snmpwalk с Zabbix-сервера: `snmpwalk -v2c -c ВашCommunity <ip-mikrotik> system`
- Убедитесь, что строка community или учётные данные SNMPv3 верны в Zabbix
- Проверьте правила файрвола на MikroTik и между Zabbix и MikroTik
- Просмотрите логи Zabbix-сервера на наличие ошибок таймаута SNMP или аутентификации

### Интерфейсы не обнаруживаются

Возможные причины:
- Фильтры LLD исключают интерфейсы, которые вы хотите мониторить
- Интерфейсы административно отключены
- SNMPv2c и 64-битные счётчики недоступны на устройстве

Решения:
- Настройте макрос `{$IF.LLD.FILTER.NOT_MATCHES}` для включения нужных типов интерфейсов
- Установите `{$IF.LLD.FILTER.ADMIN_STATUS}` для соответствия как включённым, так и выключенным интерфейсам при необходимости
- Запустите обнаружение вручную: **Настройка → Узлы сети → [Узел] → Обнаружение → Выполнить сейчас**
- Проверьте доступность интерфейсов с помощью snmpwalk для IF-MIB

### Всплески трафика или некорректные значения

Частые причины:
- Переполнение счётчиков (32-битные счётчики на высокоскоростных каналах)
- Перезагрузка устройства сбрасывает счётчики в ноль
- Интервал опроса слишком большой
- Двойной опрос с нескольких Zabbix-серверов или прокси

Исправления:
- Убедитесь, что шаблон использует 64-битные счётчики (ifHCInOctets/ifHCOutOctets)
- Проверьте, что определена правильная скорость интерфейса
- Уменьшите интервал опроса для критичных интерфейсов
- Проверьте, что только один Zabbix-сервер/прокси мониторит устройство

### Таймауты SNMP

Возможные проблемы:
- Высокая загрузка CPU на устройстве MikroTik
- Сетевые задержки или потери пакетов между Zabbix и MikroTik
- Слишком много SNMP-запросов одновременно (проверьте макс. OID на запрос)
- Файрвол или маршрутизатор ограничивает SNMP-трафик

Решения:
- Увеличьте таймаут SNMP в конфигурации интерфейса узла Zabbix
- Уменьшите частоту опроса или распределите нагрузку по нескольким прокси
- Проверьте сетевой путь с помощью ping и traceroute
- Проверьте использование CPU на MikroTik: `/system resource print`
- При необходимости настройте параметры bulk-запросов в Zabbix

---

## Дорожная карта

Запланированные улучшения для будущих релизов:

- Детальная документация по метрикам для каждого шаблона в каталоге `docs/`
- Примеры дашбордов Grafana для метрик MikroTik (через источник данных Zabbix)
- Дополнительные профили устройств RouterOS (серии CCR, CRS, hAP)
- Непрерывное тестирование с новыми релизами Zabbix и RouterOS
- Расширенный мониторинг для беспроводных интерфейсов и статистики клиентов
- Шаблоны мониторинга QoS и очередей

См. [CHANGELOG.md](CHANGELOG.md) для истории версий и реализованных функций.

---

## Как помочь проекту

Мы приветствуем вклад в проект! Чтобы внести свой вклад:

1. Откройте issue для обсуждения изменения или функции
2. Сделайте fork репозитория
3. Создайте ветку для функции: `git checkout -b feature/мое-улучшение`
4. Внесите изменения и протестируйте их на реальном устройстве MikroTik
5. Зафиксируйте изменения с понятными сообщениями: `git commit -m "Добавлена функция: описание"`
6. Отправьте в ваш fork: `git push origin feature/мое-улучшение`
7. Откройте Pull Request

**Рекомендации для участников:**
- Не изменяйте существующие ключи элементов без веской причины (это ломает существующие развёртывания)
- Документируйте протестированные версии Zabbix и RouterOS в описании PR
- Убедитесь, что XML-шаблоны валидны (используйте `xmllint` или запустите тесты в `tests/`)
- Следуйте существующей структуре и соглашениям об именовании шаблонов
- Обновите CHANGELOG.md с вашими изменениями

---

## Лицензия

Этот проект доступен для личного использования и использования в лаборатории с указанием автора.

Для коммерческого использования или развёртывания свяжитесь с автором, если у вас есть вопросы.

**Автор:** Ранас Мукминов  
**Сайт:** [run-as-daemon.ru](https://run-as-daemon.ru)
